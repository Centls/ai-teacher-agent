# AI Teacher Nexus 启动方式

## 端口配置总结

| 服务 | 端口 | 说明 |
|------|------|------|
| 前端 | 3000 | Next.js 应用 |
| 后端 | 8004 | 主服务 API |
| DOC 服务 | 8010 | MinerU 文档解析 |
| OCR 服务 | 8011 | PaddleOCR 图片识别 |
| ASR 服务 | 8012 | FunASR 音频转写 |

---

## 1. 主服务启动

### 后端服务
```bash
# 在项目根目录
.venv\Scripts\python.exe -m src.server
# 运行在 http://0.0.0.0:8004
```

### 前端服务
```bash
# 在 frontend 目录
cd frontend
npm run dev
# 运行在 http://localhost:3000
```

---

## 2. 多模态服务启动

### 方式一：一键初始化所有服务环境
```bash
# 首次使用需要初始化环境（只需运行一次）
.venv\Scripts\python.exe scripts/setup_services.py
```

### 方式二：单独初始化某个服务
```bash
# 只初始化文档服务
.venv\Scripts\python.exe scripts/setup_services.py --doc

# 只初始化 OCR 服务
.venv\Scripts\python.exe scripts/setup_services.py --ocr

# 只初始化 ASR 服务
.venv\Scripts\python.exe scripts/setup_services.py --asr

# 清理并重建环境
.venv\Scripts\python.exe scripts/setup_services.py --clean --doc
```

### 方式三：验证服务环境
```bash
# 验证所有服务环境是否正确
.venv\Scripts\python.exe scripts/setup_services.py --verify

# 运行功能测试
.venv\Scripts\python.exe scripts/test_multimodal_services.py
```

### 方式四：手动启动单个服务

#### DOC 服务 (MinerU 文档解析)
```bash
src\services\multimodal\doc\.venv\Scripts\python.exe -m src.services.multimodal.doc.server
# 运行在 http://127.0.0.1:8010
```

#### OCR 服务 (PaddleOCR 图片识别)
```bash
src\services\multimodal\ocr\.venv\Scripts\python.exe -m src.services.multimodal.ocr.server
# 运行在 http://127.0.0.1:8011
```

#### ASR 服务 (FunASR 音频转写)
```bash
src\services\multimodal\asr\.venv\Scripts\python.exe -m src.services.multimodal.asr.server
# 运行在 http://127.0.0.1:8012
```

---

## 3. 完整启动流程

### 开发环境启动顺序

1. **启动后端主服务**
   ```bash
   .venv\Scripts\python.exe -m src.server
   ```

2. **启动前端**（新终端）
   ```bash
   cd frontend
   npm run dev
   ```

3. **按需启动多模态服务**（可选，新终端）
   - **DOC 服务**: 主服务启动时自动拉起（默认配置）
   - **OCR/ASR 服务**: 需手动启动（见方式四）
   - 可在 `config/services.yaml` 中修改各服务的 `auto_start` 配置

### 访问地址
- 前端页面: http://localhost:3000
- 后端 API: http://localhost:8004
- API 文档: http://localhost:8004/docs

---

## 4. 配置文件位置

| 配置项 | 文件路径 |
|--------|----------|
| 后端端口 | `src/server.py` - `port=8004` |
| 前端端口 | `frontend/package.json` - `"dev": "next dev -p 3000"` |
| 前端连接后端 | `frontend/.env.local` - `BACKEND_URL=http://127.0.0.1:8004` |
| 多模态服务配置 | `config/services.yaml` |

---

## 5. 多模态服务架构说明

```
src/services/multimodal/
├── __init__.py          # 模块入口
├── manager.py           # 服务管理器（自动拉起子服务）
├── client.py            # 异步客户端
├── sync_client.py       # 同步客户端
├── doc/                 # MinerU 文档解析服务
│   ├── .venv/           # 独立虚拟环境
│   ├── requirements.txt
│   └── server.py
├── ocr/                 # PaddleOCR 图片识别服务
│   ├── .venv/           # 独立虚拟环境
│   ├── requirements.txt
│   └── server.py
└── asr/                 # FunASR 音频转写服务
    ├── .venv/           # 独立虚拟环境
    ├── requirements.txt
    └── server.py
```

### 依赖隔离说明
- 每个多模态服务使用独立的虚拟环境
- PaddlePaddle 和 PyTorch 分开安装，避免冲突
- 服务间通过 HTTP API 通信

### 自动启动配置

在 `config/services.yaml` 中可以配置各服务的启动行为：

| 服务 | auto_start | 默认行为 |
|------|------------|----------|
| doc | `true` | 主服务启动时自动拉起 |
| ocr | `false` | 需手动启动 |
| asr | `false` | 需手动启动 |

修改示例：
```yaml
services:
  doc:
    auto_start: true   # 自动拉起
  ocr:
    auto_start: false  # 手动启动
  asr:
    auto_start: false  # 手动启动
```

---

## 6. 已知问题

### OCR 服务 (Windows 中文用户名)
- PaddleOCR 3.x 在 Windows 中文用户名下有模型缓存路径问题
- **解决方案**: 在 Linux 服务器部署，或使用英文用户名

### ASR 服务 (editdistance 编译)
- Windows 下 `editdistance` 包需要 C++ 编译器
- **已解决**: 使用 `rapidfuzz` 替代，创建兼容层
