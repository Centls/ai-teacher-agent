# 项目上下文文档 (Project Context Document)

## 2.1 项目概要 (Project Overview)
- **项目名称**: AI Teacher Nexus (AI 教师中枢)
- **项目背景**: 构建一个基于 Multi-Agent 架构的智能系统，模拟不同领域的“教师”代理（如营销专家、客服专家、研究员），通过中央调度器（Supervisor）协调工作，以完成用户复杂的业务需求。
- **目标与目的**: 建立一个健壮、可扩展、可中断、可回溯且具备自主规划能力的代理执行环境。
- **要解决的问题**: 解决单一 Agent 无法处理复杂跨领域任务的问题，以及长流程任务中的状态保持、知识检索与自我修正问题。
- **整体愿景**: 打造一个灵活的 AI 智囊团，能够根据 PRD（产品需求文档）自动规划、执行、验证并交付高质量的业务成果。

## 2.2 范围定义 (Scope Definition)
- **当前范围**:
    - **核心架构**: Supervisor 2.0 (Planner + Router + Reviewer)。
    - **Agent 体系**: MarketingTeacher, SupportTeacher, Researcher。
    - **知识增强 (RAG)**: 基于 ChromaDB (向量) + SQLite (元数据) 的知识检索服务，支持 FastAPI 独立部署。
    - **状态管理**: NexusState (包含 execution_plan, results_buffer, reflection_score)。
    - **自我修正**: Reviewer 节点实现的反馈循环。
    - **交互界面**: 命令行交互界面 (CLI) 支持多 Agent 编排指令。
- **非本次范围**:
    - 分布式 Agent 部署 (目前为单进程多模块)。
    - 复杂的前端 GUI。
    - 大规模并发处理。
- **约束条件**:
    - 本地运行环境 (Windows)。
    - 支持 Mock 模式 (MockLLM, MockEmbeddings) 以便在无 Key 环境下开发。
    - 严格的工具权限控制与 PRD 约束注入。

## 2.3 关键实体与关系 (Key Entities & Relationships)
- **核心实体**:
    - `Supervisor` (总控): 包含 `Planner` (规划), `Router` (分发), `Reviewer` (审核)。
    - `Teacher` (执行者): 特定领域的 Agent (Marketing, Support, Researcher)。
    - `KnowledgeProvider` (知识库): 提供 RAG 能力 (Vector/Chroma/Mock)。
    - `NexusState` (状态): 全局状态容器，存储消息、计划、上下文与中间结果。
    - `PRDManager` (约束): 注入产品需求约束。
- **实体职责**:
    - `Planner`: 分析用户意图，生成 JSON 格式的多步骤执行计划。
    - `Router`: 消费执行计划，调度特定 Agent。
    - `Reviewer`: 评估 Agent 输出质量，决定通过、重试或人工干预。
    - `Researcher`: 执行网络搜索或知识库检索。
- **实体关系描述**: 
    - 用户 -> CLI -> Supervisor (Init) -> Planner -> (生成计划) -> Router -> (分发) -> Teacher -> (产出) -> Reviewer -> (反馈) -> Router (Loop) -> 结束。

## 2.4 功能模块拆解 (Functional Decomposition)
- **模块列表**: [Supervisor 2.0, RAG 服务, Agent 集群, 基础设施]
- **模块详情**:
    - **Supervisor 2.0**:
        - 输入: 复杂自然语言请求 (如 "先调研再写方案")。
        - 输出: 多步协作的最终成果。
        - 核心逻辑: LLM 规划 -> 队列执行 -> 质量门禁。
    - **RAG 服务**:
        - 核心逻辑: 文档切片 -> 向量化 (Chroma) -> 混合检索 -> 上下文增强。
        - 接口: `/ingest`, `/query`, `/status` (FastAPI)。
    - **Agent 集群**:
        - `Researcher`: 负责信息收集。
        - `MarketingTeacher`: 负责方案生成 (受 PRD 约束)。
- **典型用户场景**:
    - 用户请求 "调研 TCM 手表市场并生成营销计划" -> Planner 拆解为 [Researcher, Marketing] -> Router 依次调度 -> Researcher 输出报告 -> Marketing 基于报告生成方案 -> Reviewer 审核通过 -> 交付。

## 2.5 技术方向与关键决策 (Technical Direction & Decisions)
- **客户端**: CLI (命令行)。
- **服务端**: Python (LangGraph, FastAPI)。
- **数据存储**: 
    - 向量: ChromaDB (本地持久化)。
    - 元数据: SQLite (`rag_metadata.db`).
    - 状态: LangGraph MemorySaver (开发中), JSONL (规划中)。
- **已做技术决策**:
    - **编排引擎**: LangGraph (支持循环图与条件边)。
    - **RAG 架构**: 独立 Service 模式，通过 API 或本地类调用，解耦 Agent 与存储。
    - **规划模式**: 显式 Plan-Execute 模式 (Planner 生成静态 JSON 计划)，而非纯 ReAct 动态规划，以提高可控性。
- **可替代方案**:
    - 动态 ReAct: 灵活性高但易跑偏，当前选择静态 Plan 更稳健。

## 2.6 交互、风格与输出约定 (Interaction & Style Conventions)
- **AI 输出风格**: 结构清晰、层级明确、工程化表达。
- **表达规范**: 统一使用 Markdown；代码块需指定语言；关键路径使用 `->` 描述。
- **格式要求**: 严谨、有序、模块化、可迁移。
- **用户特殊偏好**:
    - 简洁至上 (KISS)。
    - 深度分析 (First Principles)。
    - 中文回复。

## 2.7 当前进展总结 (Current Status)
- **已确认事实**:
    - Supervisor 2.0 (Planner-Router-Reviewer) 闭环已跑通。
    - 多 Agent 串联 (Researcher -> Marketing) 验证成功。
    - RAG 模块 (Chroma+SQLite) 已集成并支持 API 服务化。
    - 解决了 Router 空计划导致的无限循环 Bug。
    - 解决了 Message 类型不匹配 (Object vs Dict) Bug。
- **未解决问题**:
    - `JSONLCheckpointSaver` 仍存在兼容性问题 (目前使用 MemorySaver)。
    - 真实 LLM 尚未全面接入 (主要依赖 MockLLM 进行逻辑验证)。

## 2.8 后续计划与风险 (Next Steps & Risks)
- **待讨论主题**:
    - 接入真实 LLM (OpenAI/Gemini) 并进行 Prompt 调优。
    - 实现跨进程的持久化 Checkpoint (修复 JSONL 或迁移至 SQLite/Postgres)。
    - 扩展更多 Agent (如 Coder, QA)。
- **潜在风险与不确定性**:
    - 真实 LLM 的输出不稳定性可能导致 Planner 生成的 JSON 解析失败 (需增强容错)。
    - Context Window 限制：多 Agent 协作产生的历史消息过长可能溢出。
- **推荐的后续初始化 Prompt**: "接入真实 LLM API，并对 Planner 和 Reviewer 进行 Prompt 优化以适应真实场景。"
