# 项目上下文文档 (Project Context Document)

## 1. 项目概要 (Project Overview)
- **项目名称**: AI Teacher Nexus
- **项目背景**: 旨在构建一个多智能体协作的 AI 老师系统，为用户提供专业、深度的教学与咨询服务。
- **目标与目的**: 提供一个统一的 Web 工作台，集成多种专业领域的 AI 老师（如市场专家、研究员等），支持实时流式对话与深度调研。
- **要解决的问题**: 解决复杂研究任务的自动化执行、多模型供应商（如阿里云百炼）的适配、以及前后端实时流式交互的稳定性。
- **整体愿景**: 打造一个可扩展、模块化的 AI 教学智能体平台。

## 2. 范围定义 (Scope Definition)
- **当前范围**: 
    - 基于 FastAPI 的后端架构与 SSE 流式接口实现。
    - 基于 Next.js + Vercel AI SDK 的前端工作台。
    - 集成 `gpt-researcher` 实现深度联网调研功能。
    - 适配阿里云百炼（Qwen-plus/max）模型。
- **非本次范围**: 
    - 浏览器自动化（browser-use）集成（规划中）。
    - 完整的 Supervisor 自动调度逻辑（重构中）。
- **约束条件**: 
    - 必须兼容 Vercel AI SDK 的 Data Stream Protocol。
    - LLM 供应商主要使用阿里云百炼。

## 3. 关键实体与关系 (Key Entities & Relationships)
- **核心实体**:
    - `Supervisor`: 负责理解用户意图并调度合适的老师智能体。
    - `Researcher Teacher`: 负责执行深度联网搜索并生成研究报告。
    - `Marketing Teacher`: 负责市场营销领域的咨询与对话。
    - `GraphFactory`: 负责构建和编译 LangGraph 工作流。
- **实体职责**:
    - `server.py`: 处理 API 请求，管理流式响应格式。
    - `nodes.py` (Researcher): 封装 `gpt-researcher` 的核心逻辑。
- **实体关系描述**: 用户通过前端选择特定老师，后端根据 `teacher_id` 路由到对应的 LangGraph 节点或直接调用工具类。

## 4. 功能模块拆解 (Functional Decomposition)
- **模块列表**: 
    - 实时对话流模块
    - 深度研究模块 (Researcher)
    - 知识库管理模块 (RAG)
- **模块详情**:
    - **深度研究模块**:
        - **输入**: 用户研究课题 (Query)。
        - **输出**: 结构化的 Markdown 研究报告。
        - **核心逻辑**: 联网搜索 -> 网页抓取 -> 信息聚合 -> LLM 总结生成。
- **典型用户场景**: 用户在侧边栏选择“研究员”，输入“2024年AI趋势”，系统在 1 分钟内生成一份详尽的调研报告。

## 5. 技术方向与关键决策 (Technical Direction & Decisions)
- **客户端**: Next.js, Tailwind CSS, Shadcn/UI, Vercel AI SDK.
- **服务端**: Python, FastAPI, LangGraph, Uvicorn.
- **模型或算法层**: 阿里云百炼 (Qwen-plus, Qwen-max), OpenAI Embeddings (兼容模式).
- **数据流与架构**: 后端使用 `StreamingResponse` 配合 Vercel AI Data Stream Protocol (`0:"text"\n`)。
- **已做技术决策**:
    - 使用 `gpt-researcher` 替代手动实现搜索抓取逻辑。
    - 暂时简化 Researcher 实现为直接调用，以解决 LangGraph 检查点器兼容性问题。
    - 统一使用 ASCII 编码保存 `.env` 以避免 Windows 环境下的编码冲突。
- **可替代方案**: 后续可将 LLM 切换为 DeepSeek 或原生 OpenAI。

## 6. 交互、风格与输出约定 (Interaction & Style Conventions)
- **AI 输出风格**: 结构清晰、层级明确、工程化表达。
- **表达规范**: 统一使用 Markdown；必要时使用列表或代码块。
- **格式要求**: 严谨、有序、模块化、可迁移。
- **用户特殊偏好**: 崇尚简洁 (KISS 原则)，避免过度工程化。

## 7. 当前进展总结 (Current Status)
- **已确认事实**:
    - 阿里云百炼 API 适配完成。
    - 前后端流式协议 (Vercel AI SDK) 对齐完成。
    - Researcher 老师深度研究功能已跑通。
- **未解决问题**:
    - `gpt-researcher` 的 `language="chinese"` 参数导致底层 LLM 调用异常（已暂时回退到英文输出）。
    - Researcher 节点尚未完全重构回 LangGraph 工作流。

## 8. 后续计划与风险 (Next Steps & Risks)
- **待讨论主题**:
    - 如何在不修改库源码的情况下实现 Researcher 的中文稳定输出。
    - Supervisor 2.0 的能力驱动调度实现。
- **潜在风险与不确定性**:
    - 联网搜索的稳定性受网络环境和 API 限制影响。
    - 深度研究耗时较长，需持续优化前端加载体验。
- **推荐的后续初始化 Prompt**: "请基于当前项目上下文，协助我将 Researcher 老师重构回 LangGraph 工作流，并解决 thread_id 缺失的问题。"
