# 项目上下文文档 (Project Context Document)

## 1. 项目概要 (Project Overview)

*   **项目名称**: AI Teacher Nexus (Nexus 2.0)
*   **项目背景**: 本项目是一个基于“强依赖复用”模式构建的生产级 AI Agent 应用，旨在重构和升级原有的 AI 教学系统。项目利用成熟的开源架构（如 LangGraph, FastAPI, Next.js）来构建一个具备高级推理、记忆和工具使用能力的 AI 营销导师。
*   **目标与目的**: 
    1.  构建一个稳定、可扩展的 AI 代理后端，支持多 Agent 协作（Supervisor 模式）。
    2.  提供“高级感”的前端交互体验，支持流式输出、富文本、附件管理和人机交互（HITL）。
    3.  实现高质量的 RAG（检索增强生成），包含混合检索和重排序，确保回答的专业性和准确性。
*   **要解决的问题**: 解决传统 AI 聊天机器人缺乏领域深度、无法有效利用外部知识库、缺乏长期记忆以及难以进行人工干预（HITL）的问题。
*   **整体愿景**: 打造一个能够像真人专家一样进行教学、咨询和协作的 AI 智能体平台。

## 2. 范围定义 (Scope Definition)

*   **当前范围**:
    *   **后端重构**: 基于 FastAPI 和 LangGraph 的异步服务架构。
    *   **营销智能体 (Marketing Agent)**: 包含检索、生成、查询重写、自省（Hallucination Check）和学习（Reflection）能力的完整工作流。
    *   **RAG 系统**: 基于 ChromaDB 和 BM25 的混合检索流水线，支持文件上传、持久化存储和管理。
    *   **前端重构**: 使用 Next.js 15 + Tailwind CSS 构建的现代化 Chat UI，集成 `assistant-ui` 概念。
    *   **知识库管理**: 完整的文件上传、列表查看、删除和元数据管理功能。
    *   **人机回环 (HITL)**: 支持在生成前请求用户审核检索结果，并根据反馈调整。
*   **非本次范围**:
    *   大规模分布式部署（目前聚焦于单机/本地环境）。
    *   多租户 SaaS 架构（目前为单用户/本地模式）。
    *   除“营销老师”外的其他复杂学科老师的深度实现（目前以营销 Agent 为主 MVP）。
*   **约束条件**:
    *   **运行环境**: Windows 本地环境。
    *   **技术栈**: Python (Backend), TypeScript/Next.js (Frontend).
    *   **开发原则**: White-box Reuse（白盒复用），优先参考和适配现有开源代码，而非从零发明。

## 3. 关键实体与关系 (Key Entities & Relationships)

*   **核心实体**:
    *   `MarketingTeacher` (Agent): 核心业务智能体，负责处理营销相关咨询。
    *   `Supervisor` (Orchestrator): 负责多智能体之间的路由和调度（目前主要调度 MarketingTeacher）。
    *   `RAGPipeline` (Service): 负责文档的加载、切分、向量化（ChromaDB）、检索和重排序（BM25）。
    *   `Store` (Memory): 基于 SQLite 的持久化存储，用于保存用户偏好（User Rules）和反思记录。
    *   `KnowledgeBase` (Data): 包含原始文件存储 (`data/uploads`)、元数据数据库 (`data/knowledge.db`) 和向量索引 (`chroma_db`)。
*   **实体职责**:
    *   `MarketingTeacher`: 执行 Retrieve -> Grade -> Generate -> Reflect 循环。
    *   `Supervisor`: 接收用户输入，决定分发给哪个 Agent。
    *   `RAGPipeline`: 提供 `ingest`, `retrieve`, `delete_document` 接口。
    *   `Frontend`: 提供聊天界面、文件上传入口、知识库管理弹窗、HITL 审核卡片。
*   **实体关系描述**:
    *   Frontend 通过 HTTP/SSE 与 Backend (`server.py`) 通信。
    *   Backend 初始化 `Supervisor`，`Supervisor` 调度 `MarketingTeacher`。
    *   `MarketingTeacher` 在运行时调用 `RAGPipeline` 获取上下文。
    *   `MarketingTeacher` 读写 `Store` 以获取和更新用户偏好。

## 4. 功能模块拆解 (Functional Decomposition)

*   **模块列表**:
    1.  **Agentic Backend (LangGraph)**
    2.  **RAG Service**
    3.  **Knowledge Base Management**
    4.  **Frontend Chat Interface**
    5.  **Long-term Memory & Learning**

*   **模块详情**:
    *   **Agentic Backend**:
        *   输入: 用户消息、附件、线程 ID。
        *   输出: 流式 Token、工具调用状态、中断请求 (HITL)。
        *   核心逻辑: 状态机流转。先检索，若相关性低则重写查询；若相关性高则生成；生成后检查幻觉；必要时请求人工介入。
    *   **RAG Service**:
        *   输入: 查询字符串或文件路径。
        *   输出: 相关文档片段 (Document objects)。
        *   核心逻辑: Hybrid Search (Vector + Keyword) -> Re-ranking (BM25Plus)。
    *   **Knowledge Base Management**:
        *   输入: 文件上传/删除请求。
        *   输出: 操作状态、文件列表。
        *   核心逻辑: 文件存盘 -> SQLite 记录元数据 -> Chroma 建立索引；删除时级联清理。
    *   **Frontend Chat Interface**:
        *   输入: 用户文本、点击操作。
        *   输出: 渲染的对话气泡、Markdown 内容、交互式组件（审核卡片）。
        *   核心逻辑: 处理 SSE 流，维护对话状态，展示附件预览。

*   **典型用户场景**:
    *   用户上传一份营销报告到知识库 -> 提问“这份报告的核心策略是什么？” -> Agent 检索报告 -> Agent 生成回答 -> Agent 自动反思并记住用户的偏好。
    *   用户提问 -> Agent 检索文档 -> Agent 发现文档可能不精准 -> 触发 HITL 请求用户审核 -> 用户确认或拒绝 -> Agent 继续生成或重试。

## 5. 技术方向与关键决策 (Technical Direction & Decisions)

*   **客户端**: Next.js 15 (App Router), Tailwind CSS, Lucide Icons, Fetch API (用于流式处理)。
*   **服务端**: Python 3.11+, FastAPI, LangGraph, LangChain, Uvicorn。
*   **模型或算法层**:
    *   LLM: DeepSeek (通过 OpenAI 兼容接口)。
    *   Embedding: OpenAIEmbeddings (配置为兼容 Aliyun/Local 模型)。
    *   Re-ranking: `rank_bm25` (BM25Plus 算法)。
*   **数据流与架构**:
    *   **流式协议**: Server-Sent Events (SSE)，自定义事件类型 (`token`, `status`, `interrupt`, `done`)。
    *   **状态持久化**: `AsyncSqliteSaver` 用于 LangGraph Checkpoints。
*   **已做技术决策**:
    *   **附件分离**: 临时聊天附件 (`/upload/attachment`) 与 永久知识库 (`/upload/knowledge`) 分离设计，避免污染知识库。
    *   **白盒复用 RAG**: 不使用 LangChain 封装过深的 RetrievalQA 链，而是直接在 Node 中调用 `pipeline.retrieve` 以获得更细粒度的控制（如重排序、引用注入）。
    *   **UUID 文件名**: 上传文件重命名为 `{uuid}_{filename}` 以防止覆盖，但数据库保留原始文件名用于展示。
*   **可替代方案**:
    *   曾考虑使用 `PostgreSQL` + `pgvector`，但为了本地轻量化选择了 `SQLite` + `ChromaDB`。

## 6. 交互、风格与输出约定 (Interaction & Style Conventions)

*   **AI 输出风格**: 结构清晰、层级明确、工程化表达。
*   **表达规范**: 统一使用 Markdown；必要时使用伪代码或列表。
*   **格式要求**: 严谨、有序、模块化、可迁移。
*   **用户特殊偏好**:
    *   **语言**: 必须使用中文回复。
    *   **指令**: 每次回复包含 `Implementation Plan, Task List and Thought in Chinese`（在 Agent 模式下已内化为 Task Boundary）。
    *   **原则**: KISS (Keep It Simple, Stupid)，第一性原理，事实为本。

## 7. 当前进展总结 (Current Status)

*   **已确认事实**:
    *   RAG 流程已打通，支持混合检索和重排序。
    *   知识库管理功能（上传、列表、删除）已完整实现并通过测试。
    *   前端已集成知识库管理入口。
    *   遗留的“幽灵”文档已通过脚本清理完毕。
    *   HITL 流程已优化，支持向前端传递上下文信息。
*   **未解决问题**:
    *   暂无明显的阻碍性问题 (Blockers)。
    *   *待优化*: 知识库目前仅支持文本类文件，图片/PDF 解析效果依赖于 `langchain` 加载器的基础能力，可能需要增强 OCR 或更复杂的解析。

## 8. 后续计划与风险 (Next Steps & Risks)

*   **待讨论主题**:
    *   是否需要引入多用户/鉴权系统？
    *   是否需要扩展支持更多的文件格式（如 PPT, Excel 深度解析）？
    *   是否需要部署到云端环境？
*   **潜在风险与不确定性**:
    *   **本地向量库性能**: 随着文档数量增加，ChromaDB 本地版性能可能下降。
    *   **LLM 上下文限制**: 检索过多文档可能超出 DeepSeek 的上下文窗口（虽然目前已做截断）。
*   **推荐的后续初始化 Prompt**:
    *   "检查当前 RAG 检索的准确率，并尝试优化 Prompt 以减少幻觉。"
    *   "为 Marketing Agent 添加一个新的工具（例如网络搜索），并集成到 Supervisor 路由中。"
