# 项目上下文文档 (Project Context Document)

## 1. 项目概要 (Project Overview)
- **项目名称**: AI Teacher Nexus (AI 营销老师工作台)
- **项目背景**: 基于 `agent-service-toolkit`、`Agentic-RAG` 和 `content-writer` 等开源项目进行"白盒复用"重构，旨在构建一个模块化、可扩展的 AI 教学与辅助系统。
- **目标与目的**: 提供一个具备领域专业知识（如营销）、支持人机协作（HITL）、具备自我反思与学习能力的 AI 智能体平台。
- **要解决的问题**: 通用大模型在特定领域（营销）缺乏深度知识，且缺乏长期记忆与用户偏好适应能力。
- **整体愿景**: 打造一个"越用越懂你"的 AI 专家团队（Supervisor + Teachers），通过多智能体协作解决复杂问题。

## 2. 范围定义 (Scope Definition)
- **当前范围**:
    - **营销智能体 (MarketingTeacher)**: 基于 CRAG (Corrective RAG) 架构，支持检索、评分、生成、幻觉检测。
    - **多智能体编排 (Supervisor 2.0)**: 路由分发任务给 `MarketingTeacher` 或 `GeneralAssistant`。
    - **人机协作 (HITL)**: 支持在生成前中断，由用户审批检索到的文档。
    - **反馈学习 (Feedback Learning)**: 基于用户反馈自动更新偏好规则 (Store)。
    - **全栈架构**: FastAPI 后端 + Next.js 前端。
- **非本次范围**:
    - 复杂的多租户权限管理。
    - 支付与计费系统。
    - 语音/视频交互。
- **约束条件**:
    - 必须使用 DeepSeek (OpenAI Compatible) 作为 LLM。
    - 必须遵循"白盒复用"原则，直接集成外部代码而非黑盒调用。
    - 运行环境为 Windows + Python 虚拟环境。

## 3. 关键实体与关系 (Key Entities & Relationships)
- **核心实体**:
    - `NexusSupervisor`: 顶层编排者，负责意图识别与路由。
    - `MarketingTeacher`: 营销领域专家 (Sub-Graph)，负责专业问答。
    - `GeneralAssistant`: 通用助手 (Agent)，负责闲聊与基础问答。
    - `RAGPipeline`: 检索服务，负责文档摄入与查询。
    - `Store`: 长期记忆存储，保存用户偏好规则 (`user_rules`)。
- **实体职责**:
    - `NexusSupervisor`: 接收用户 Query -> 决策 -> 调用子智能体 -> 返回结果。
    - `MarketingTeacher`: 接收 Query -> 检索(RAG) -> 评分 -> (HITL) -> 生成 -> 质检 -> 返回。
    - `Store`: 存储 `marketing_preferences` 命名空间下的规则，供 `learning_node` 更新和 `generate_node` 读取。
- **实体关系描述**:
    - Supervisor 包含 MarketingTeacher 和 GeneralAssistant。
    - MarketingTeacher 依赖 RAGPipeline 获取知识。
    - MarketingTeacher 读写 Store 以实现个性化。

## 4. 功能模块拆解 (Functional Decomposition)
- **模块列表**:
    - `src.server`: FastAPI 服务入口。
    - `src.agents.supervisor`: 多智能体编排图。
    - `src.agents.marketing`: 营销智能体图 (Nodes, Graph, Prompts, Learning)。
    - `src.services.rag`: RAG 检索服务。
    - `frontend`: Next.js 用户界面。
- **模块详情**:
    - **Marketing Graph**:
        - **输入**: `question`, `messages`
        - **输出**: `generation`, `messages`
        - **核心逻辑**: Retrieve -> Grade -> (HITL) -> Generate -> Check Quality。
    - **Learning Node**:
        - **输入**: `user_feedback`, `messages`
        - **输出**: 更新 Store 中的 `user_rules`
        - **核心逻辑**: 调用 LLM 分析对话历史，提取偏好规则。
- **典型用户场景**:
    - 用户提问营销方案 -> Supervisor 路由至 MarketingTeacher -> 检索文档 -> 请求用户审批 -> 用户批准 -> 生成方案。
    - 用户反馈"太长了" -> Learning Node 更新规则"偏好简短回答" -> 重新生成。

## 5. 技术方向与关键决策 (Technical Direction & Decisions)
- **客户端**: Next.js 14 (App Router), TailwindCSS, shadcn/ui, `assistant-ui` (参考)。
- **服务端**: Python FastAPI, Uvicorn (Reload enabled)。
- **模型或算法层**:
    - **LLM**: DeepSeek (via `langchain_openai`).
    - **Orchestration**: LangGraph (StateGraph, Supervisor).
    - **Memory**: `AsyncSqliteSaver` (Checkpoints), `InMemoryStore` (Preferences - 暂定).
- **已做技术决策**:
    - **Supervisor 2.0**: 使用 `langgraph-supervisor` 库而非手写 Router。
    - **HITL**: 使用 `interrupt()` 函数而非 `interrupt_before` 配置 (LangGraph v0.2+)。
    - **Learning**: 移植 `content-writer` 的 `REFLECTION_PROMPT` 逻辑。
- **可替代方案**:
    - Store 可替换为 PostgreSQL 以实现持久化。
    - RAG 向量库可替换为 Milvus/Qdrant (目前使用 Chroma/Local)。

## 6. 交互、风格与输出约定 (Interaction & Style Conventions)
- **AI 输出风格**: 结构清晰、层级明确、工程化表达。
- **表达规范**: 统一使用 Markdown；代码块需指定语言；文件路径使用绝对路径。
- **格式要求**: 严谨、有序、模块化、可迁移。
- **用户特殊偏好**: 强调"白盒复用"，即理解源码后集成，而非盲目拷贝。

## 7. 当前进展总结 (Current Status)
- **已确认事实**:
    - Supervisor 2.0 架构已跑通。
    - HITL 审批流程已集成。
    - 营销智能体 (CRAG) 逻辑已移植。
    - 反馈学习 (Learning Node) 已实现并集成到 Graph 入口。
- **未解决问题**:
    - **知识库为空**: 导致 CRAG 流程中检索不到文档，触发递归限制 (Recursion Limit)。
    - **Store 持久化**: 目前使用 `InMemoryStore`，重启服务后用户偏好丢失。

## 8. 后续计划与风险 (Next Steps & Risks)
- **待讨论主题**:
    - 是否引入 Postgres 替换 SQLite 以支持更复杂的 Store。
    - 前端如何更好地展示"已学习的规则" (参考 `content-writer` 的 Dialog)。
- **潜在风险与不确定性**:
    - RAG 检索效果依赖于文档质量。
    - 多智能体路由可能在复杂 Query 下出现误判。
- **推荐的后续初始化 Prompt**:
    - "请实现 Store 的持久化，使用 SQLite 文件存储。"
    - "请上传测试文档到 RAG 知识库，并验证端到端流程。"
