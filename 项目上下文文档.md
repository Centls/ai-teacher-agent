# 项目上下文文档 (Project Context Document)

## 2.1 项目概要 (Project Overview)
- **项目名称**: AI Teacher Nexus (AI 教师中枢)
- **项目背景**: 构建一个基于 Multi-Agent 架构的智能系统，模拟不同领域的“教师”代理（如营销专家、客服专家），通过中央调度器（Supervisor）协调工作，以完成用户复杂的业务需求。
- **目标与目的**: 建立一个健壮、可扩展、可中断、可回溯的代理执行环境。
- **要解决的问题**: 解决单一 Agent 无法处理复杂跨领域任务的问题，以及长流程任务中的状态保持与恢复问题。
- **整体愿景**: 打造一个灵活的 AI 智囊团，能够根据 PRD（产品需求文档）自动执行并交付高质量的业务成果。

## 2.2 范围定义 (Scope Definition)
- **当前范围**:
    - 核心架构搭建 (Supervisor + Teachers)。
    - 营销 (Marketing) 与 客服 (Support) 教师的实现。
    - 内存分层体系 (Session/Execution/Global Memory)。
    - 检查点与断点续传机制 (Checkpoint & Resume)。
    - 命令行交互界面 (CLI)。
    - 工具注册与治理机制 (Tool Registry)。
- **非本次范围**:
    - 真实的 LLM 接入 (目前使用 MockLLM)。
    - 分布式部署。
    - 复杂的前端界面。
- **约束条件**:
    - 本地运行环境 (Windows)。
    - 必须支持 Mock 模式。
    - 严格的工具权限控制。
    - 暂时回退使用 In-Memory Checkpoint (由于 LangGraph 1.0.5 兼容性问题)。

## 2.3 关键实体与关系 (Key Entities & Relationships)
- **核心实体**:
    - `Supervisor` (调度器): 负责意图识别与任务分发。
    - `Teacher` (教师): 特定领域的执行代理 (如 MarketingTeacher, SupportTeacher)。
    - `SessionManager` (会话管理): 管理用户会话生命周期。
    - `GraphFactory` (图工厂): 负责组装 LangGraph 工作流并注入依赖。
    - `Checkpointer` (检查点保存器): 负责状态持久化。
- **实体职责**:
    - `Supervisor`: 路由请求，处理拒绝，聚合结果。
    - `MarketingTeacher`: 生成营销计划，执行推广任务。
    - `SupportTeacher`: 处理退款，解答常见问题。
- **实体关系描述**: 用户 -> SessionManager -> GraphFactory -> Supervisor -> (路由) -> Teachers -> (调用) -> Tools。

## 2.4 功能模块拆解 (Functional Decomposition)
- **模块列表**: [核心框架, 教师模块, 内存模块, 基础设施]
- **模块详情**:
    - **核心框架**:
        - 输入: 用户自然语言请求。
        - 输出: 结构化执行结果。
        - 核心逻辑: 基于 LangGraph 的状态机流转。
    - **内存模块**:
        - 核心逻辑: 分层管理 Session (会话级), Execution (执行级), Global (全局) 状态。
    - **检查点模块**:
        - 核心逻辑: 在每个 Node 执行后保存状态快照，支持 `--resume` 恢复。
- **典型用户场景**:
    - 用户请求生成营销方案 -> Supervisor 路由至 MarketingTeacher -> 生成方案 -> 结束。
    - 任务执行中途崩溃 -> 用户使用 `--resume` -> 系统从崩溃前的最后状态继续执行。

## 2.5 技术方向与关键决策 (Technical Direction & Decisions)
- **客户端**: CLI (命令行界面)。
- **服务端**: Python 运行时。
- **模型或算法层**: LangGraph (编排), MockLLM (模拟推理)。
- **数据流与架构**:
    - 状态流转: 基于 `TypedDict` 的 StateGraph。
    - 持久化: 计划使用 JSONL (目前暂用 MemorySaver)。
- **已做技术决策**:
    - 采用 LangGraph 作为核心编排引擎。
    - 采用分层内存架构解耦状态管理。
    - 强制工具白名单注册机制。
- **可替代方案**:
    - 暂无信息。

## 2.6 交互、风格与输出约定 (Interaction & Style Conventions)
- **AI 输出风格**: 结构清晰、层级明确、工程化表达。
- **表达规范**: 统一使用 Markdown；必要时使用伪代码或列表。
- **格式要求**: 严谨、有序、模块化、可迁移。
- **用户特殊偏好**:
    - 简洁至上 (KISS)。
    - 深度分析 (First Principles)。
    - 中文回复。

## 2.7 当前进展总结 (Current Status)
- **已确认事实**:
    - 核心路由与执行逻辑验证通过。
    - 内存分层接口已定义并实现。
    - Checkpoint 机制在进程内 (In-Memory) 验证通过。
    - CLI 支持 `--resume` 参数。
- **未解决问题**:
    - 自定义 `JSONLCheckpointSaver` 与 `langgraph 1.0.5` 存在兼容性问题 (TypeError)，导致无法跨进程持久化。

## 2.8 后续计划与风险 (Next Steps & Risks)
- **待讨论主题**:
    - 如何修复或重构 JSONL Checkpointer 以适配新版 LangGraph。
    - GlobalMemory 的具体存储实现 (DB vs File)。
- **潜在风险与不确定性**:
    - LangGraph 版本更新可能带来更多 API 变更。
    - 随着 Teacher 数量增加，路由准确率可能下降。
- **推荐的后续初始化 Prompt**: "请修复 JSONLCheckpointSaver 的兼容性问题，并实现跨进程的断点续传。"
